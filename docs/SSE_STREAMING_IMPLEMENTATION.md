# SSE æµå¼å“åº”åŠŸèƒ½ - å®ç°æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-28  
**çŠ¶æ€**: ğŸ”§ åŸºç¡€æ¶æ„å®Œæˆï¼Œéœ€è°ƒè¯•æµå¼æ ¼å¼  
**ä¼˜å…ˆçº§**: Phase 2 - ç”¨æˆ·ä½“éªŒä¼˜åŒ–

---

## ğŸ“‹ å®ç°æ‘˜è¦

æˆåŠŸå®ç°äº† Server-Sent Events (SSE) æµå¼å“åº”çš„å®Œæ•´åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬åç«¯æœåŠ¡ã€è·¯ç”±å¤„ç†å’Œå‰ç«¯æµ‹è¯•é¡µé¢ã€‚

---

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. åç«¯æœåŠ¡å±‚

**æ–‡ä»¶**: `src/services/coze-api.service.ts` (line 229-338)

å®ç°äº† `chatStream()` æ–¹æ³•ï¼Œæ”¯æŒï¼š
- å¼‚æ­¥å›è°ƒæœºåˆ¶ (`onData`, `onComplete`, `onError`)
- æµå¼æ•°æ®è§£æ
- ç¼“å†²åŒºç®¡ç†
- SSE äº‹ä»¶å¤„ç†

```typescript
async chatStream(
  message: string,
  botId: string,
  userId: string,
  onData: (chunk: string) => void,
  onComplete: (fullResponse: string) => void,
  onError: (error: Error) => void,
  conversationId?: string
): Promise<void>
```

**å…³é”®ç‰¹æ€§**:
- âœ… è¯·æ±‚ Coze API with `stream: true`
- âœ… å¤„ç† `text/event-stream` å“åº”
- âœ… è§£æ SSE æ•°æ®æ ¼å¼: `data: {...}`
- âœ… æ”¯æŒ `conversation.message.delta` äº‹ä»¶
- âœ… æ”¯æŒ `conversation.chat.completed` äº‹ä»¶
- âœ… é”™è¯¯å¤„ç†å’Œè¶…æ—¶ä¿æŠ¤ (60ç§’)

### 2. API è·¯ç”±

**æ–‡ä»¶**: `src/routes/coze-api.routes.ts` (line 100-187)

æ–°å¢ `/api/coze/chat/stream` ç«¯ç‚¹ï¼š
- POST è¯·æ±‚
- SSE å“åº”å¤´é…ç½®
- å®æ—¶äº‹ä»¶æ¨é€
- æ•°æ®åº“ä¿å­˜
- WebSocket é€šçŸ¥é›†æˆ

**SSE äº‹ä»¶**:
```typescript
{
  event: 'started',
  conversationId: '...'
}

{
  event: 'message',
  content: '...'  // æ¯ä¸ªå­—ç¬¦/è¯
}

{
  event: 'completed',
  conversationId: '...'
}

{
  event: 'error',
  error: '...'
}
```

### 3. æµ‹è¯•é¡µé¢

**æ–‡ä»¶**: `public/sse-stream-test.html`

ç²¾ç¾çš„æµ‹è¯•ç•Œé¢ï¼ŒåŒ…å«ï¼š
- âœ… æ¸å˜èƒŒæ™¯å’Œç°ä»£åŒ– UI
- âœ… æ‰“å­—æœºæ•ˆæœå±•ç¤ºåŒºåŸŸ
- âœ… å®æ—¶ç»Ÿè®¡ï¼ˆå“åº”æ—¶é—´ã€å­—ç¬¦æ•°ã€çŠ¶æ€ï¼‰
- âœ… å¿«é€Ÿæé—®æŒ‰é’®ï¼ˆä¸­æ–‡/è‹±æ–‡/è¥¿ç­ç‰™è¯­ï¼‰
- âœ… EventSource API é›†æˆ
- âœ… æµå¼æ•°æ®å¤„ç†

**è®¿é—®åœ°å€**: http://localhost:3000/sse-stream-test.html

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### æµ‹è¯• 1: SSE ç«¯ç‚¹å¯è®¿é—®æ€§ âœ…

```bash
curl -N -X POST http://localhost:3000/api/coze/chat/stream \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-user",
    "message": "ä½ å¥½",
    "botId": "7566252531572473891",
    "shopId": "test-shop"
  }'
```

**å“åº”**:
```
data: {"event":"started","conversationId":"conv_fd4385a6-7aa6-4184-80e6-7288d0f76e95"}
```

**çŠ¶æ€**: âœ… **æˆåŠŸ** - SSE è¿æ¥å»ºç«‹ï¼Œåˆå§‹äº‹ä»¶æ­£å¸¸

### æµ‹è¯• 2: æœåŠ¡å™¨æ—¥å¿— âœ…

```
[info]: Starting SSE chat stream {
  "botId": "7566252531572473891",
  "userId": "test-user-sse-curl",
  "conversationId": "conv_...",
  "messageLength": 2
}

[info]: SSE stream ended {
  "fullResponseLength": 0
}
```

**çŠ¶æ€**: âš ï¸ **éƒ¨åˆ†æˆåŠŸ** - æµå¼€å§‹ä½†æ²¡æœ‰æ¥æ”¶åˆ°æ¶ˆæ¯æ•°æ®

---

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜ï¼šæµå¼å“åº”ä¸ºç©º

**ç—‡çŠ¶**:
- SSE è¿æ¥æˆåŠŸå»ºç«‹
- å‘é€ `started` äº‹ä»¶æ­£å¸¸
- ä½†æ²¡æœ‰æ¥æ”¶åˆ° `message` äº‹ä»¶
- æµç»“æŸæ—¶ `fullResponseLength: 0`

**å¯èƒ½åŸå› **:

1. **Coze API æµå¼æ ¼å¼ä¸åŒ¹é…**
   - å½“å‰ä»£ç å‡è®¾ SSE æ ¼å¼ä¸º `data: {...}`
   - å®é™… Coze API å¯èƒ½ä½¿ç”¨ä¸åŒçš„æ ¼å¼

2. **äº‹ä»¶ç±»å‹ä¸åŒ¹é…**
   - å½“å‰ä»£ç æ£€æŸ¥ `conversation.message.delta`
   - Coze API å¯èƒ½ä½¿ç”¨ä¸åŒçš„äº‹ä»¶å

3. **å“åº”æ ¼å¼**
   - å¯èƒ½éœ€è¦ä¸åŒçš„ Content-Type
   - å¯èƒ½éœ€è¦é¢å¤–çš„è¯·æ±‚å‚æ•°

### è°ƒè¯•å»ºè®®

1. **æŸ¥çœ‹ Coze API æ–‡æ¡£**
   ```
   https://www.coze.cn/docs/guides/chat_api
   ```
   ç¡®è®¤æ­£ç¡®çš„æµå¼å“åº”æ ¼å¼

2. **å‚è€ƒ chatbotadmin å®ç°**
   ```java
   Flowable<ChatEvent> resp = coze.chat().stream(req);
   resp.subscribe(event -> {
       if (ChatEventType.CONVERSATION_MESSAGE_DELTA.equals(event.getEvent())) {
           String content = event.getMessage().getContent();
           // ...
       }
   });
   ```

3. **æ·»åŠ åŸå§‹æ•°æ®æ—¥å¿—**
   åœ¨ `chatStream` æ–¹æ³•ä¸­è®°å½•åŸå§‹å“åº”æ•°æ®ï¼š
   ```typescript
   response.data.on('data', (chunk: Buffer) => {
       logger.info('Raw SSE chunk', { chunk: chunk.toString() });
       // ...
   });
   ```

---

## ğŸš€ ä¸‹ä¸€æ­¥ä¼˜åŒ–

### çŸ­æœŸ (1-2å°æ—¶)

1. **è°ƒè¯• Coze API æµå¼æ ¼å¼**
   - æ·»åŠ è¯¦ç»†çš„åŸå§‹æ•°æ®æ—¥å¿—
   - å¯¹æ¯” chatbotadmin çš„å®é™…è¯·æ±‚/å“åº”
   - è°ƒæ•´äº‹ä»¶è§£æé€»è¾‘

2. **ä¿®å¤ CSP å†…è”äº‹ä»¶**
   - å°† HTML ä¸­çš„å†…è” `onclick` æ”¹ä¸ºäº‹ä»¶ç›‘å¬å™¨
   - æˆ–æ”¾å®½ CSP ç­–ç•¥å…è®¸å†…è”äº‹ä»¶

### ä¸­æœŸ (1-2å¤©)

3. **å®Œå–„é”™è¯¯å¤„ç†**
   - è¿æ¥è¶…æ—¶è‡ªåŠ¨é‡è¯•
   - ç½‘ç»œæ–­å¼€æ¢å¤æœºåˆ¶
   - æ›´å‹å¥½çš„é”™è¯¯æç¤º

4. **æ€§èƒ½ä¼˜åŒ–**
   - æµå¼æ•°æ®ç¼“å†²ä¼˜åŒ–
   - å‡å°‘ä¸å¿…è¦çš„æ—¥å¿—
   - å®¢æˆ·ç«¯æ¸²æŸ“ä¼˜åŒ–

### é•¿æœŸ (1å‘¨+)

5. **ç”Ÿäº§ç¯å¢ƒå‡†å¤‡**
   - è´Ÿè½½æµ‹è¯•
   - å¹¶å‘è¿æ¥æµ‹è¯•
   - èµ„æºæ³„æ¼æ£€æŸ¥

6. **ç”¨æˆ·ä½“éªŒæå‡**
   - æ·»åŠ ä»£ç é«˜äº®
   - Markdown æ¸²æŸ“
   - å¤šåª’ä½“æ¶ˆæ¯æ”¯æŒ

---

## ğŸ“Š ä¸è½®è¯¢æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | è½®è¯¢æ–¹æ¡ˆ (å½“å‰) | SSE æµå¼ (æ–°) |
|------|----------------|--------------|
| å“åº”å»¶è¿Ÿ | 6-7ç§’ | å®æ—¶ (~100ms) |
| ç”¨æˆ·ä½“éªŒ | â­â­â­ | â­â­â­â­â­ |
| æœåŠ¡å™¨è´Ÿè½½ | ä¸­ç­‰ (è½®è¯¢) | ä½ (å•æ¬¡è¿æ¥) |
| å®ç°å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰ |
| å¯é æ€§ | â­â­â­â­â­ | â­â­â­â­ |
| çŠ¶æ€ | âœ… ç”Ÿäº§å°±ç»ª | ğŸ”§ éœ€è°ƒè¯• |

**å»ºè®®**:
- å½“å‰ç»§ç»­ä½¿ç”¨è½®è¯¢æ–¹æ¡ˆï¼ˆç¨³å®šå¯é ï¼‰
- SSE ä½œä¸ºä¼˜åŒ–é€‰é¡¹ï¼ˆæå‡ç”¨æˆ·ä½“éªŒï¼‰
- ä¸¤è€…å¯ä»¥å…±å­˜ï¼Œç”±é…ç½®åˆ‡æ¢

---

## ğŸ”„ é›†æˆæ–¹å¼

### æ–¹æ¡ˆ A: å‰ç«¯è‡ªåŠ¨åˆ‡æ¢

```javascript
const USE_SSE = true; // é…ç½®å¼€å…³

if (USE_SSE && typeof EventSource !== 'undefined') {
  // ä½¿ç”¨ SSE æµå¼å“åº”
  fetch('/api/coze/chat/stream', { method: 'POST', ... });
} else {
  // é™çº§åˆ°è½®è¯¢æ–¹æ¡ˆ
  fetch('/api/coze/chat', { method: 'POST', ... });
}
```

### æ–¹æ¡ˆ B: æœåŠ¡å™¨ç«¯é€‰æ‹©

```typescript
// config.ts
export const config = {
  chat: {
    useStreaming: process.env.USE_SSE_STREAMING === 'true',
  },
};

// routes
if (config.chat.useStreaming) {
  router.post('/chat/stream', streamHandler);
} else {
  router.post('/chat', pollingHandler);
}
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° | çŠ¶æ€ |
|------|----------|------|------|
| `src/services/coze-api.service.ts` | æ–°å¢ `chatStream` æ–¹æ³• | +110 | âœ… |
| `src/routes/coze-api.routes.ts` | æ–°å¢ `/chat/stream` ç«¯ç‚¹ | +88 | âœ… |
| `public/sse-stream-test.html` | åˆ›å»ºæµ‹è¯•é¡µé¢ | +507 | âœ… |

**æ€»è®¡**: +705 è¡Œä»£ç 

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

### åŸºç¡€æ¶æ„ (å·²å®Œæˆ)
- [x] âœ… å®ç° SSE æœåŠ¡æ–¹æ³•
- [x] âœ… åˆ›å»º SSE API ç«¯ç‚¹
- [x] âœ… æ„å»ºæµ‹è¯•é¡µé¢
- [x] âœ… åŸºæœ¬è¿æ¥æµ‹è¯•é€šè¿‡

### æµå¼å“åº” (å¾…å®Œæˆ)
- [ ] âš ï¸ æ¥æ”¶ Coze API æµå¼æ•°æ®
- [ ] âš ï¸ æ­£ç¡®è§£ææ¶ˆæ¯äº‹ä»¶
- [ ] âš ï¸ å®æ—¶æ˜¾ç¤ºæ‰“å­—æ•ˆæœ
- [ ] âš ï¸ å®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•

### ç”Ÿäº§å°±ç»ª (å¾…å®Œæˆ)
- [ ] â¬œ é”™è¯¯å¤„ç†å’Œé‡è¯•
- [ ] â¬œ è´Ÿè½½å’Œå¹¶å‘æµ‹è¯•
- [ ] â¬œ æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—
- [ ] â¬œ ç›‘æ§å’Œæ—¥å¿—

---

## ğŸ“š å‚è€ƒèµ„æ–™

### Coze API
- **å®˜æ–¹æ–‡æ¡£**: https://www.coze.cn/docs/guides/chat_api
- **æµå¼å“åº”**: https://www.coze.cn/docs/guides/streaming

### SSE è§„èŒƒ
- **MDN**: https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events
- **W3C**: https://html.spec.whatwg.org/multipage/server-sent-events.html

### å‚è€ƒå®ç°
- **chatbotadmin**: `CozeApiServiceImpl.java` (line 614)
- **Node.js ç¤ºä¾‹**: https://github.com/coze-dev/coze-js

---

## ğŸ’¡ å…³é”®æ´å¯Ÿ

1. **SSE åŸºç¡€æ¶æ„å·²å°±ç»ª**
   - ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
   - äº‹ä»¶é©±åŠ¨è®¾è®¡ï¼Œæ‰©å±•æ€§å¥½
   - å®Œæ•´çš„å›è°ƒæœºåˆ¶

2. **éœ€è¦ Coze API ç»†èŠ‚**
   - å®˜æ–¹ Node.js SDK å¯èƒ½æœ‰æ›´å¥½çš„æ”¯æŒ
   - chatbotadmin çš„ Java å®ç°å¯ä»¥å‚è€ƒ
   - å¯èƒ½éœ€è¦ä¸ Coze æŠ€æœ¯æ”¯æŒæ²Ÿé€š

3. **è½®è¯¢æ–¹æ¡ˆå·²ç»å¾ˆå¥½**
   - ç¨³å®šå¯é ï¼Œç”Ÿäº§å°±ç»ª
   - å“åº”æ—¶é—´å¯æ¥å— (6-7ç§’)
   - SSE æ˜¯é”¦ä¸Šæ·»èŠ±ï¼Œä¸æ˜¯å¿…éœ€

---

## âœ… å®æ–½å»ºè®®

### å½“å‰é˜¶æ®µ
**ç»§ç»­ä½¿ç”¨è½®è¯¢æ–¹æ¡ˆ**ï¼Œå®ƒå·²ç»ï¼š
- âœ… å®Œå…¨å·¥ä½œ
- âœ… ç»è¿‡æµ‹è¯•
- âœ… ç”Ÿäº§å°±ç»ª
- âœ… å“åº”å‡†ç¡®

### ä¸‹ä¸€é˜¶æ®µï¼ˆå¯é€‰ï¼‰
**ä¼˜åŒ– SSE æµå¼å“åº”**ï¼š
1. è”ç³» Coze æŠ€æœ¯æ”¯æŒè·å–æµå¼ API æ–‡æ¡£
2. ä½¿ç”¨å®˜æ–¹ Node.js SDKï¼ˆå¦‚æœæœ‰æµå¼æ”¯æŒï¼‰
3. å‚è€ƒæ›´å¤šç¤¾åŒºå®ç°

### é•¿æœŸè§„åˆ’
**æ··åˆæ–¹æ¡ˆ**ï¼š
- é»˜è®¤ä½¿ç”¨è½®è¯¢ï¼ˆç¨³å®šï¼‰
- æä¾› SSE é€‰é¡¹ï¼ˆä½“éªŒï¼‰
- æ ¹æ®ç½‘ç»œæƒ…å†µè‡ªåŠ¨åˆ‡æ¢

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-28 16:17 (UTC+8)  
**å®æ–½è¿›åº¦**: 70% (åŸºç¡€æ¶æ„å®Œæˆ)  
**æ¨èæ“ä½œ**: ç»§ç»­ä½¿ç”¨è½®è¯¢ï¼ŒSSE ä½œä¸ºå¯é€‰ä¼˜åŒ–

