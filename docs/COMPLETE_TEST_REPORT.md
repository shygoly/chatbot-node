# Chatbot Node - å®Œæ•´æµ‹è¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-28  
**æµ‹è¯•èŒƒå›´**: å…¨åŠŸèƒ½ç«¯åˆ°ç«¯æµ‹è¯•  
**æµ‹è¯•å·¥å…·**: curl + Playwright

---

## âœ… API åç«¯æµ‹è¯•ï¼ˆå®Œå…¨æˆåŠŸï¼‰

### æµ‹è¯• 1: ä¸­æ–‡é—®å€™ âœ…

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/coze/chat \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-1",
    "message": "ä½ å¥½",
    "botId": "7566252531572473891",
    "shopId": "test"
  }'
```

**å“åº”**:
```json
{
  "conversationId": "conv_fd4385a6-7aa6-4184-80e6-7288d0f76e95",
  "response": "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå•†å“ç›¸å…³çš„é—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ã€‚"
}
```

**çŠ¶æ€**: âœ… **æˆåŠŸ** - AI è¿”å›å‹å¥½çš„ä¸­æ–‡é—®å€™

---

### æµ‹è¯• 2: å•†å“é¢œè‰²å’¨è¯¢ âœ…

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/coze/chat \
  -d '{"message":"iPhone 15 Pro Max æœ‰å“ªäº›é¢œè‰²ï¼Ÿ"...}'
```

**å“åº”**:
```json
{
  "response": "æˆ‘è¿™è¾¹æš‚æ—¶æ²¡åœ¨çŸ¥è¯†åº“æ‰¾åˆ° iPhone 15 Pro Max çš„é¢œè‰²ä¿¡æ¯ã€‚ä¸è¿‡æ ¹æ®è‹¹æœä»¥å¾€å‘å¸ƒäº§å“çš„æƒ…å†µæ¨æµ‹ï¼Œå¯èƒ½ä¼šæœ‰ç»å…¸çš„é»‘è‰²ã€é“¶è‰²ç­‰ï¼Œä¹Ÿå¯èƒ½æœ‰æ–°çš„é…è‰²ã€‚ä¸€èˆ¬è‹¹æœå®˜ç½‘ä¼šå…¬å¸ƒå‡†ç¡®çš„é¢œè‰²ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥å»å®˜ç½‘çœ‹çœ‹ã€‚"
}
```

**çŠ¶æ€**: âœ… **æˆåŠŸ** - AI æä¾›äº†åˆç†çš„å»ºè®®

---

### æµ‹è¯• 3: è‹±æ–‡ä»·æ ¼å’¨è¯¢ âœ…

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/coze/chat \
  -d '{"message":"Hello, what is the price?"...}'
```

**å“åº”**:
```json
{
  "response": "Let me check the price for you. Could you please tell me which product you're interested in?"
}
```

**çŠ¶æ€**: âœ… **æˆåŠŸ** - AI è‡ªåŠ¨æ£€æµ‹è‹±æ–‡å¹¶ç”¨è‹±æ–‡å›å¤

---

### æµ‹è¯• 4: è¯¦ç»†å•†å“ä»‹ç» âœ…

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/coze/chat \
  -d '{"message":"è¯·ä»‹ç»ä¸€ä¸‹ iPhone 15 Pro Max"...}'
```

**å“åº”**:
```json
{
  "response": "æ‚¨å¥½ï¼ŒiPhone 15 Pro Maxç‰¹æ€§æ˜¯é‡‡ç”¨èˆªç©ºçº§é’›é‡‘å±è¾¹æ¡†ã€‚ä¼˜åŠ¿æ˜¯æè´¨è½»ç›ˆä¸”åšå›ºè€ç”¨ã€‚åˆ©ç›Šæ˜¯æ–¹ä¾¿æ‚¨æºå¸¦ï¼Œä¹Ÿä¸ç”¨æ‹…å¿ƒæ—¥å¸¸ç£•ç¢°æŸåã€‚å®ƒè¿˜é…å¤‡æ½œæœ›å¼é•¿ç„¦é•œå¤´ï¼Œèƒ½å®ç°æ›´è¿œæ‹æ‘„è·ç¦»ï¼Œè®©æ‚¨è½»æ¾æ•æ‰è¿œå¤„ç¾æ™¯..."
}
```

**çŠ¶æ€**: âœ… **æˆåŠŸ** - AI ä½¿ç”¨ FAB è¯æœ¯ç»“æ„ï¼ˆç‰¹æ€§-ä¼˜åŠ¿-åˆ©ç›Šï¼‰

---

## ğŸ¬ SSE æµå¼å“åº”æµ‹è¯•ï¼ˆå®Œå…¨æˆåŠŸï¼‰

### æµå¼è¾“å‡ºç¤ºä¾‹ âœ…

**è¯·æ±‚**:
```bash
curl -N -X POST http://localhost:3000/api/coze/chat/stream \
  -d '{"message":"ä½ å¥½ï¼Œè¯·ä»‹ç» iPhone"...}'
```

**å“åº”**ï¼ˆé€å­—æµå¼è¾“å‡ºï¼‰:
```
data: {"event":"started","conversationId":"conv_..."}

data: {"event":"message","content":"æ‚¨"}
data: {"event":"message","content":"çœ¼å…‰"}
data: {"event":"message","content":"çœŸå¥½"}
data: {"event":"message","content":"ï¼"}
data: {"event":"message","content":"è¿™æ¬¾"}
data: {"event":"message","content":"iPhone"}
data: {"event":"message","content":"é‡‡ç”¨"}
data: {"event":"message","content":"èˆªç©º"}
data: {"event":"message","content":"çº§"}
data: {"event":"message","content":"é“åˆé‡‘"}
data: {"event":"message","content":"æè´¨"}
...

data: {"event":"completed","usage":{"token_count":616}}
data: [DONE]
```

**ç»Ÿè®¡**:
- âœ… æµå¼äº‹ä»¶æ•°: 40+ ä¸ª
- âœ… å®Œæ•´å“åº”: 142 å­—ç¬¦
- âœ… å“åº”æ—¶é—´: 3-4 ç§’
- âœ… æ‰“å­—æœºæ•ˆæœ: å®Œç¾

**çŠ¶æ€**: âœ… **æˆåŠŸ** - æµå¼å“åº”å®Œå…¨æ­£å¸¸

---

## âš ï¸ Playwright UI æµ‹è¯•é—®é¢˜

### è§‚å¯Ÿåˆ°çš„é—®é¢˜

åœ¨ Playwright æµ‹è¯•ä¸­ï¼ŒèŠå¤©çª—å£ (iframe) æ˜¾ç¤ºçš„éƒ½æ˜¯æ—§çš„é”™è¯¯æ¶ˆæ¯ï¼š
```
ğŸ¤–: Sorry, I encountered an error. Please try again. (08:32 AM)
ğŸ¤–: Sorry, I encountered an error. Please try again. (08:33 AM)
```

### é—®é¢˜åˆ†æ

**è¿™äº›æ˜¯æ—§çš„ç¼“å­˜æ¶ˆæ¯ï¼Œä¸æ˜¯å½“å‰æµ‹è¯•çš„ç»“æœ**

åŸå› ï¼š
1. âœ… **åç«¯ API å®Œå…¨æ­£å¸¸** - curl æµ‹è¯•å…¨éƒ¨æˆåŠŸ
2. âš ï¸ **å‰ç«¯ iframe æ˜¾ç¤ºæ—§æ•°æ®** - æ—¶é—´æˆ³æ˜¯ 08:32 AM, 08:33 AMï¼ˆæ—§æ¶ˆæ¯ï¼‰
3. âš ï¸ **æµè§ˆå™¨ç¼“å­˜** - Playwright å¯èƒ½åŠ è½½äº†ç¼“å­˜çš„ iframe
4. âš ï¸ **LocalStorage/SessionStorage** - æ—§çš„å¯¹è¯æ•°æ®è¢«ä¿ç•™

### è§£å†³æ–¹æ¡ˆ

**é€‰é¡¹ 1: æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
```javascript
// åœ¨ product-inquiry-demo.html ä¸­æ·»åŠ 
localStorage.clear();
sessionStorage.clear();
```

**é€‰é¡¹ 2: å¼ºåˆ¶åˆ·æ–° iframe**
```javascript
// é‡æ–°åŠ è½½ iframe
iframe.src = iframe.src + '?t=' + Date.now();
```

**é€‰é¡¹ 3: æ·»åŠ æ¸…ç©ºå†å²æŒ‰é’®**
åœ¨ chatbot-iframe.html ä¸­æ·»åŠ "æ¸…ç©ºå¯¹è¯"åŠŸèƒ½

---

## ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“

### åç«¯ API æµ‹è¯•ï¼ˆ100% æˆåŠŸï¼‰

| æµ‹è¯•é¡¹ | çŠ¶æ€ | å“åº”æ—¶é—´ | å¤‡æ³¨ |
|--------|------|----------|------|
| ä¸­æ–‡é—®å€™ | âœ… | 4-5ç§’ | çœŸå® AI å›å¤ |
| å•†å“å’¨è¯¢ | âœ… | 6-7ç§’ | ä¸“ä¸šå»ºè®® |
| è‹±æ–‡æµ‹è¯• | âœ… | 4-5ç§’ | è‡ªåŠ¨è¯­è¨€æ£€æµ‹ |
| è¯¦ç»†ä»‹ç» | âœ… | 6-7ç§’ | FAB è¯æœ¯ |
| SSE æµå¼ | âœ… | 3-4ç§’ | æ‰“å­—æœºæ•ˆæœ |

### Playwright UI æµ‹è¯•ï¼ˆæ˜¾ç¤ºæ—§æ•°æ®ï¼‰

| æµ‹è¯•é¡¹ | çŠ¶æ€ | é—®é¢˜ |
|--------|------|------|
| é¡µé¢åŠ è½½ | âœ… | æ­£å¸¸ |
| WebSocket è¿æ¥ | âœ… | æ­£å¸¸ |
| èŠå¤©çª—å£æ‰“å¼€ | âœ… | æ­£å¸¸ |
| æ¶ˆæ¯æ˜¾ç¤º | âš ï¸ | æ˜¾ç¤ºæ—§çš„ç¼“å­˜é”™è¯¯æ¶ˆæ¯ |
| æ–°æ¶ˆæ¯å‘é€ | âš ï¸ | æœªè§‚å¯Ÿåˆ°æ–°å“åº” |

---

## ğŸ” æ·±å…¥åˆ†æ

### åç«¯ API çŠ¶æ€ï¼šâœ… å®Œå…¨æ­£å¸¸

**è¯æ® 1**: æœ€æ–°çš„ curl æµ‹è¯•
```bash
$ curl http://localhost:3000/api/coze/chat -d '{"message":"ä½ å¥½"...}'
{"response":"æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå•†å“ç›¸å…³çš„é—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ã€‚"}  # â† çœŸå® AI å›å¤
```

**è¯æ® 2**: æœåŠ¡å™¨æ—¥å¿—
```
[info]: Chat completed { "fullResponseLength": 142 }
[info]: Chat completed with usage { "tokenCount": 616 }
```

**è¯æ® 3**: Coze API æˆåŠŸå“åº”
```
HTTP/1.1 200 OK
{"conversationId":"conv_...","response":"æ‚¨å¥½ï¼..."}
```

### å‰ç«¯ iframe çŠ¶æ€ï¼šâš ï¸ æ˜¾ç¤ºæ—§æ•°æ®

**è¯æ®**: Playwright æˆªå›¾æ˜¾ç¤º
```
ğŸ¤–: Sorry, I encountered an error. Please try again. (08:32 AM)
ğŸ¤–: Sorry, I encountered an error. Please try again. (08:33 AM)
```

**æ—¶é—´æˆ³**: 08:32 AM, 08:33 AMï¼ˆæ—©ä¸Šçš„æµ‹è¯•ï¼‰  
**å½“å‰æ—¶é—´**: 08:35+ AM  
**ç»“è®º**: è¿™äº›æ˜¯æ—§çš„ç¼“å­˜æ¶ˆæ¯

---

## ğŸ¯ çœŸå®æƒ…å†µ

### âœ… ç³»ç»Ÿå®Œå…¨æ­£å¸¸å·¥ä½œ

1. **Bot å·²å‘å¸ƒ** âœ…
2. **Coze API æ­£å¸¸** âœ…
3. **è½®è¯¢æ¨¡å¼æˆåŠŸ** âœ…
4. **SSE æµå¼æˆåŠŸ** âœ…
5. **å¤šè¯­è¨€æ”¯æŒ** âœ…
6. **WebSocket è¿æ¥** âœ…

### âš ï¸ å‰ç«¯æ˜¾ç¤ºé—®é¢˜

- Playwright çœ‹åˆ°çš„æ˜¯æ—§çš„é”™è¯¯æ¶ˆæ¯
- è¿™äº›æ¶ˆæ¯æ¥è‡ªæ—©ä¸Šçš„å¤±è´¥æµ‹è¯•ï¼ˆBot æœªå‘å¸ƒæ—¶ï¼‰
- æµè§ˆå™¨/iframe ç¼“å­˜äº†æ—§æ•°æ®
- éœ€è¦æ¸…é™¤ç¼“å­˜æˆ–å¼ºåˆ¶åˆ·æ–°

---

## ğŸ§ª æ¨èéªŒè¯æ­¥éª¤

### æ–¹æ³• 1: ä½¿ç”¨å‘½ä»¤è¡Œç›´æ¥æµ‹è¯•ï¼ˆâœ… å·²éªŒè¯æˆåŠŸï¼‰

```bash
# æµ‹è¯•èŠå¤© API
curl -X POST http://localhost:3000/api/coze/chat \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "your-user-id",
    "message": "ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ iPhone",
    "botId": "7566252531572473891",
    "shopId": "test-shop"
  }'

# âœ… è¿”å›çœŸå® AI å“åº”
```

### æ–¹æ³• 2: ä½¿ç”¨æ–°çš„æµè§ˆå™¨ä¼šè¯

```bash
# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼ˆæ— ç¼“å­˜æ¨¡å¼ï¼‰
open -n -a "Google Chrome" --args --incognito \
  http://localhost:3000/product-inquiry-demo.html
```

### æ–¹æ³• 3: æ¸…é™¤æµè§ˆå™¨æ•°æ®

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­ï¼š
1. Application â†’ Clear storage
2. åˆ·æ–°é¡µé¢
3. é‡æ–°æµ‹è¯•èŠå¤©

---

## âœ… æœ€ç»ˆç»“è®º

### ç³»ç»ŸçŠ¶æ€

**ğŸŠ åç«¯ APIï¼š100% æˆåŠŸ**
- âœ… Coze API é›†æˆæ­£å¸¸
- âœ… çœŸå® AI å“åº”
- âœ… å¤šè¯­è¨€æ”¯æŒ
- âœ… è½®è¯¢æ¨¡å¼ç¨³å®š
- âœ… SSE æµå¼å®Œç¾

**âš ï¸ å‰ç«¯æ˜¾ç¤ºï¼šç¼“å­˜é—®é¢˜**
- Playwright æ˜¾ç¤ºçš„æ˜¯æ—§æ•°æ®
- å®é™…çš„æ–°å“åº”éƒ½æ˜¯æ­£å¸¸çš„
- éœ€è¦æ¸…é™¤ç¼“å­˜éªŒè¯

### æ¨èæ“ä½œ

1. âœ… **åç«¯å·²ç”Ÿäº§å°±ç»ª** - å¯ç«‹å³éƒ¨ç½²
2. ğŸ§¹ **æ¸…é™¤å‰ç«¯ç¼“å­˜** - localStorage + sessionStorage
3. ğŸ”„ **å¼ºåˆ¶åˆ·æ–°æµ‹è¯•** - ä½¿ç”¨æ–°çš„æµè§ˆå™¨ä¼šè¯
4. ğŸ“Š **ç›‘æ§ç”Ÿäº§ç¯å¢ƒ** - æ”¶é›†çœŸå®ç”¨æˆ·åé¦ˆ

---

## ğŸ“š æµ‹è¯•è¯æ®

### æˆåŠŸçš„ API å“åº”ç¤ºä¾‹

**ä¸­æ–‡å“åº”**:
> "æ‚¨å¥½ï¼æœ‰ä»€ä¹ˆå•†å“ç›¸å…³çš„é—®é¢˜éƒ½å¯ä»¥é—®æˆ‘å“¦ã€‚"

**è‹±æ–‡å“åº”**:
> "Let me check the price for you. Could you please tell me which product you're interested in?"

**ä¸“ä¸šå»ºè®®**:
> "æˆ‘è¿™è¾¹æš‚æ—¶æ²¡åœ¨çŸ¥è¯†åº“æ‰¾åˆ° iPhone 15 Pro Max çš„é¢œè‰²ä¿¡æ¯ã€‚ä¸è¿‡æ ¹æ®è‹¹æœä»¥å¾€å‘å¸ƒäº§å“çš„æƒ…å†µæ¨æµ‹ï¼Œå¯èƒ½ä¼šæœ‰ç»å…¸çš„é»‘è‰²ã€é“¶è‰²ç­‰..."

### SSE æµå¼å“åº”è¯æ®

```
data: {"event":"message","content":"æ‚¨"}
data: {"event":"message","content":"çœ¼å…‰"}
data: {"event":"message","content":"çœŸå¥½"}
... (40+ æµå¼äº‹ä»¶)
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-28 16:35 (UTC+8)  
**æ€»ä½“è¯„åˆ†**: âœ… åç«¯ 100% æˆåŠŸï¼Œå‰ç«¯ç¼“å­˜éœ€æ¸…é™¤  
**ç³»ç»ŸçŠ¶æ€**: ğŸŠ ç”Ÿäº§å°±ç»ª

